---
layout: post
title: Hack This Site - Realistic - seculas Ltd.
---

Welcome back to my walkthrough of hackthissite.org's CTF missions. I will be going through my thought process of how I solved these missions, and therefore also giving away the solutions. If you came across this to give you hints, watch out for spoilers! Good luck, have fun.

Our next realistic mission asks us to find out information about some patents that a military technology company has filed. As always, I will begin with an overall investigation of their website. Unlike the previous missions, I will only explain certain things that are interesting and the overall structure of the website as opposed to anything and everything that seems like it could be useful. This is to ensure that these writeups don't get astronomically long as did the previous mission - which was broken anyways. 

One thing that you would notice right away, if inspecting the page source of the landing page, is the metadata that is embedded into the page. There is an interesting author tag that has the following information:
```
webadmin: Susy Slack, email s.slack@seculas.com
```

Another point of interest is when submitting an application for a job, there is an image that comes from `_backups_/_images/` instead of the usual `images/` that the rest of the website uses. This is a point of interest that should be further investigated. Visiting the `_backups_/` folder, we see that there is a `.zip` file that is supposed as some sort of backup. Trying to extract the zip file, we are prompted with a password field, and thus it is evident that we must try and figure out this password. Overall, the website has the following structure:

- index.htm
- products.php
- questions.php
- imprint.php
- jobs.php
- application_form.php
- storeapplication.php
  - POST
    - Form Data:
      - Position
      - FirstName
      - LastName
      - Street
      - City
      - State_Province
      - Zip_PostalCode
      - Country
      - email
      - xtraskills
- storequestion.php
  - POST
    - Form Data:
      - FirstName
      - LastName
      - Company
      - Department
      - Street
      - City
      - State_Province 
      - Zip_PostalCode
      - Country
      - email
      - question
- styles.css
- images/
  - {a bunch of images}
- \_backups\_/
  - _images/
    - {a bunch of images, with one overlap w/ images/}
  - backup.zip {password locked}
    - misc (files from different folders)/
      - shell.php
      - index.htm
    - internal_messages/
      - msgshow.php
      - msgauth.php

I will begin with a quick 'basic password' check using JohnTheRipper. I will do so by using the `zip2john` tool and then trying to crack the hash that it outputs. The following commands are what was done: `zip2john backup.zip > backupzip.hash; john backupzip.hash`. JohnTheRipper had very quickly defaulted back to incremental ASCII mode, which suggests that the password is not something simple that can be found in my default password list. At this moment on, there is one thing that can be noted about the leaked contents of `backup.zip`, that being the file `index.htm`. If you noticed, it has the same name as the landing page, and there doesn't seem to be any other `index.htm` page present within the active directory. This would suggest that our backup zip folder contains _some_ version of the `index.htm` page. This suggests that we could use a known-plaintext attack in order to crack the password that was used. Unfortunately, this would only work if the two files have enough in common for the encryption key to be shown.

What I will be using is the tool `pkcrack`, which can be found [here](https://github.com/keyunluo/pkcrack). It requires 13 bytes of plaintext in order to decrypt the target ZIP folder. In order to use this tool, we are required to - in addition to the ZIP folder we are trying to crack - have a ZIP-archive that is unencrypted that contains at least one file that has the same compression method that was used as the encrypted file. Thus, we must download the `index.htm` file, and create a ZIP folder using the same compression algorithm as the creators of this `backup.zip` folder. Since I don't know which method was used, I will start with the basic method. When using the tool, it was indeed able to crack the encryption key, and thus we now have the unencrypted backup zip folder available for investigation.

I will first explore the `shell.php` file to see whether we can find some configuration details about the host target machine. It informs me that its setup using selfSecure, with the root user being `root` and everyone else under `others`. Unfortunately, their passwords have been removed. The adminEmail is set to `admin@seculas.com`. It shows that the shell has access to all directories on the machine.

Moving onto the `internal_messages/` folder, it implies that there may be a 'hidden' folder with the same name in the website. Starting off with `msgshow.php`, a comment says that it is called by `internal_messages.php`. This script includes some `showmessages.inc.php`, collects the `password` and `username` fields of the incomming POST request. Then includes the other file that is present in this ZIP, `msgauth.php`, and subsequently calls a function that seems to show messages that are related to the `username` that was passed. Shifting my attention to `msgauth.php`, we can see that it maintains a session mapping for all of its users. This script seems to authenticate a POST request in relation to the passed `{username, password}` fields. It ensures that the passed credentials are present, adds escape slashes to the parsed `{username, password}` fields. Opens a file pointer to `files/msgpasswords.txt` and reads 199 bytes (fgets() reads length - 1 bytes) or until newline (included) or an EOF is noticed. It uses the contents of this file to match against `username:password` to try and authenticate a user request. If it doesn't match against any user, the request is not authenticated.

From here, we can try and look for the two following endpoints: `{files/, internal_messages/}` (side note, files/ is most likely at the root of the directory as opposed to being exposed to the HTTP/HTTPS server). As expected, `files/msgpasswords.txt` is not a valid address, and  `internal_messages/internal_messages.php` is a valid address.

We can see that this form is used as an authentication form for 3 users - `{Dr. Nuts, J. Bardus, admin}` - to view their messages. Each login form makes a `POST` request to `msgshow.php` with the form fields `{username, password}` as expected from our cracked source code. Right away, one thing that I can try to do is use that interesting metadata tag that I noticed in the first investigation.